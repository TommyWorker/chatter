{% import 'common.tpl' as c %}
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>トーク画面</title>

    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/icon/bootstrap-icons-1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/custom.css" rel="stylesheet">

    <style>
        .chat-container {
            max-width: 700px;
            margin: 50px auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            height: 70vh;
            background: white;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .message-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 15px;
            white-space: pre-wrap;
        }
        .message.sent {
            background-color: #0d6efd;
            color: white;
            align-self: flex-end;
        }
        .message.received {
            background-color: #e9ecef;
            align-self: flex-start;
        }
        .sender-name {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        .chat-input {
            border-top: 1px solid #ddd;
            padding: 10px;
        }
        textarea {
            resize: none;
        }
    </style>
</head>
<body>
    <div class="sticky-top bg-white">
        {{ c.common_header(login_user, mode | default("")) }}
        <div class="container">
            <div id="div_message_area">
                {% if result=="complete" %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{sys_msg}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% elif result=="error" %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{sys_msg}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% elif result=="info" %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{sys_msg}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
            </div>
            <div class="mt-3 bg-white w-100 border-bottom border-dark row mb-2">
                <div class="col-auto">
                    <h3>トーク画面</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="message-wrapper">
                <div class="sender-name">XXXさん</div>
                <div class="message received">こんにちは！</div>
            </div>
            <div class="message-wrapper">
                <div class="sender-name text-end">あなた</div>
                <div class="message sent">やあ！元気ですか？</div>
            </div>
        </div>

        <div class="chat-input">
            <form id="chatForm" class="d-flex flex-column">
                <textarea id="chatInput" class="form-control mb-2" placeholder="メッセージを入力..." rows="2"></textarea>
                <!-- <button type="submit" class="btn btn-outline-primary align-self-end">送信</button> -->
            </form>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        const chatForm = document.getElementById("chatForm");
        const chatInput = document.getElementById("chatInput");
        const chatMessages = document.getElementById("chatMessages");

        // IME入力中フラグ
        let isComposing = false;
        chatInput.addEventListener("compositionstart", () => isComposing = true);
        chatInput.addEventListener("compositionend", () => isComposing = false);

        // 自分のメッセージ追加
        function addMyMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("message-wrapper");

            const sender = document.createElement("div");
            sender.classList.add("sender-name", "text-end");
            sender.textContent = "あなた";

            const messageEl = document.createElement("div");
            messageEl.classList.add("message", "sent");
            messageEl.textContent = text;

            wrapper.appendChild(sender);
            wrapper.appendChild(messageEl);
            chatMessages.appendChild(wrapper);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 相手のメッセージ追加
        function addOtherMessage(text, senderName = "XXX") {
            const wrapper = document.createElement("div");
            wrapper.classList.add("message-wrapper");

            const sender = document.createElement("div");
            sender.classList.add("sender-name");
            sender.textContent = senderName + "さん";

            const messageEl = document.createElement("div");
            messageEl.classList.add("message", "received");
            messageEl.textContent = text;

            wrapper.appendChild(sender);
            wrapper.appendChild(messageEl);
            chatMessages.appendChild(wrapper);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // フォーム送信
        chatForm.addEventListener("submit", function(e) {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            if (messageText !== "") {
                addMyMessage(messageText);
                chatInput.value = "";

                // デモ：相手から返信
                setTimeout(() => {
                    addOtherMessage("これはサーバーからの返信です！", "山田");
                }, 2000);
            }
        });

        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                if (e.shiftKey) return; // Shift+Enterは改行
                if (isComposing) return; // IME確定前は送信しない
                e.preventDefault();
                chatForm.dispatchEvent(new Event("submit"));
            }
        });

    </script>
</body>
</html>
